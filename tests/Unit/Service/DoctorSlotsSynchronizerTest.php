<?php

declare(strict_types=1);

namespace Tests\Unit\Service;

use App\Entity\Doctor;
use App\Entity\Slot;
use App\Service\DoctorSlotsSynchronizer;
use Doctrine\ORM\EntityManagerInterface;
use Doctrine\Persistence\ObjectRepository;
use PHPUnit\Framework\TestCase;
use Psr\Log\LoggerInterface;

class DoctorSlotsSynchronizerTest extends TestCase
{
    private EntityManagerInterface $entityManager;
    private ObjectRepository $doctorRepository;
    private ObjectRepository $slotRepository;
    private LoggerInterface $logger;
    private DoctorSlotsSynchronizer $synchronizer;

    protected function setUp(): void
    {
        // Create mocks for dependencies
        $this->entityManager = $this->createMock(EntityManagerInterface::class);
        $this->doctorRepository = $this->createMock(ObjectRepository::class);
        $this->slotRepository = $this->createMock(ObjectRepository::class);
        $this->logger = $this->createMock(LoggerInterface::class);

        // Configure the entity manager to return the repositories
        $this->entityManager->method('getRepository')
            ->willReturnMap([
                [Doctor::class, $this->doctorRepository],
                [Slot::class, $this->slotRepository],
            ]);

        // Initialize the synchronizer
        $this->synchronizer = $this->getMockBuilder(DoctorSlotsSynchronizer::class)
            ->setConstructorArgs([
                $this->entityManager,
                $this->logger,
                'http://test-endpoint',
                'test_user',
                'test_password',
            ])
            ->onlyMethods(['fetchData'])
            ->getMock();
    }

    public function testSynchronizeDoctorSlots(): void
    {
        // Arrange
        $doctorData = [
            ['id' => 1, 'name' => 'Rafa Terrero'],
        ];

        $slotsData = [
            ['start' => '2023-10-01T09:00:00', 'end' => '2023-10-01T10:00:00'],
        ];

        // Mock fetchData to return JSON-encoded doctor and slot data
        $this->synchronizer->method('fetchData')
            ->willReturnCallback(function ($url) use ($doctorData, $slotsData) {
                if (strpos($url, '/slots') !== false) {
                    return json_encode($slotsData);
                }
                return json_encode($doctorData);
            });

        // Mock doctorRepository to return null when find() is called (doctor doesn't exist)
        $this->doctorRepository->method('find')
            ->willReturn(null);

        // Expect that persist() will be called twice: once for the Doctor, once for the Slot
        $this->entityManager->expects($this->exactly(2))
            ->method('persist')
            ->withConsecutive(
                [$this->callback(function ($doctor) {
                    return $doctor instanceof Doctor && $doctor->getId() === 1;
                })],
                [$this->callback(function ($slot) {
                    return $slot instanceof Slot;
                })]
            );

        // Expect that flush() will be called twice
        $this->entityManager->expects($this->exactly(2))
            ->method('flush');

        // Act
        $this->synchronizer->synchronizeDoctorSlots();

        // Assert
        // Since we're using mocks and setting expectations, if the expectations are met, the test passes
        $this->assertTrue(true);
    }

    public function testProcessDoctorUpdatesExistingDoctor(): void
    {
        // Arrange
        $doctorData = ['id' => 1, 'name' => 'Rafa Terrero Updated'];
        $existingDoctor = new Doctor(1, 'Rafa Terrero');

        // Mock doctorRepository to return the existing doctor
        $this->doctorRepository->method('find')
            ->with(1)
            ->willReturn($existingDoctor);

        // Allow persist to be called multiple times
        $this->entityManager->expects($this->atLeastOnce())
            ->method('persist')
            ->with($this->callback(function ($entity) use ($existingDoctor) {
                return $entity === $existingDoctor;
            }));

        // Act
        $reflection = new \ReflectionClass($this->synchronizer);
        $method = $reflection->getMethod('processDoctor');
        $method->setAccessible(true);
        $method->invoke($this->synchronizer, $doctorData);

        // Assert
        $this->assertEquals('Rafa Terrero Updated', $existingDoctor->getName());
    }

    public function testFetchDoctorSlotsHandlesJsonException(): void
    {
        // Arrange
        $doctor = new Doctor(1, 'Rafa Terrero');

        // Mock fetchData to return invalid JSON
        $this->synchronizer->method('fetchData')
            ->willReturn('invalid json');

        // Expect that an error is logged
        $this->logger->expects($this->once())
            ->method('error')
            ->with(
                $this->stringContains('Error to get slots for the doctor.'),
                $this->arrayHasKey('exception')
            );

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // Act
        $reflection = new \ReflectionClass($this->synchronizer);
        $method = $reflection->getMethod('fetchDoctorSlots');
        $method->setAccessible(true);
        $result = iterator_to_array($method->invoke($this->synchronizer, $doctor));

        // Assert
        $this->assertContains(false, $result);
    }

    public function testNormalizeNameHandlesSpecialCases(): void
    {
        // Arrange
        $fullName = "o'malley john";
        $expected = "O'Malley John";

        // Act
        $reflection = new \ReflectionClass($this->synchronizer);
        $method = $reflection->getMethod('normalizeName');
        $method->setAccessible(true);
        $normalized = $method->invoke($this->synchronizer, $fullName);

        // Assert
        $this->assertEquals($expected, $normalized);
    }
}
